{
  "Comment": "A description of my state machine",
  "StartAt": "InsertWorkflowDataToDocDB",
  "States": {
    "InsertWorkflowDataToDocDB": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.InsertWorkflowDataToDocDB",
      "OutputPath": "$",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-datastorelambda",
        "Payload": {
          "input.$": "$$.Execution.Input",
          "orderId.$": "$$.Execution.Input.orderId",
          "workflowId.$": "$$.Execution.Name",
          "action": "insert"
        }
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "UpdateLegacyMLAutomationStart"
    },
    "UpdateLegacyMLAutomationStart": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.UpdateLegacyMLAutomationStart",
      "OutputPath": "$",
      "Parameters": {
        "Payload": {
          "orderId.$": "$$.Execution.Input.orderId",
          "reportId.$": "$$.Execution.Input.reportId",
          "workflowId.$": "$$.Execution.Name",
          "taskName": "UpdateLegacyMLAutomationStart",
          "callType": "eagleflow",
          "status": "MAStarted",
          "requestData": {}
        },
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "MeasurementAutomation"
    },
    "MeasurementAutomation": {
      "Type": "Parallel",
      "Next": "ThrottleService",
      "Branches": [
        {
          "StartAt": "GetImageMetaData",
          "States": {
            "GetImageMetaData": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "ResultSelector": {
                "response.$": "$.Payload"
              },
              "ResultPath": "$.GetImageMetaData",
              "OutputPath": "$",
              "Parameters": {
                "Payload": {
                  "requestData": {},
                  "url": "https://mustangs.free.beeceptor.com/GetImageMetaData",
                  "requestMethod": "GET",
                  "headers": {},
                  "isWaitTask": false,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 5,
                  "storeDataToS3": "",
                  "taskName": "GetImageMetaData",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "callType": "Service",
                  "auth": {}
                },
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "ImageSelection"
            },
            "ImageSelection": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.ImageSelection",
              "OutputPath": "$",
              "Parameters": {
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
                "Payload": {
                  "requestData": {
                    "orderId.$": "$$.Execution.Input.orderId",
                    "address.$": "$$.Execution.Input.address",
                    "getImageMetadata.$": "$.GetImageMetaData.response.GetImageMetaDataLocation"
                  },
                  "url": "https://api.cmh.platform-dev2.evinternal.net/factory-automeasure/ma-image-selector/v2/image-selection",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "ImageSelection",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "taskToken.$": "$$.Task.Token",
                  "callType": "Service",
                  "auth": {}
                }
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "FacetKeyPointDetection"
            },
            "FacetKeyPointDetection": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.FacetKeyPointDetection",
              "OutputPath": "$",
              "Parameters": {
                "Payload": {
                  "requestData": {
                    "orderId.$": "$$.Execution.Input.orderId",
                    "address.$": "$$.Execution.Input.address",
                    "getImageMetadata.$": "$.GetImageMetaData.response.GetImageMetaDataLocation",
                    "imageSelectionService.$": "$.ImageSelection.response.imageSelectionLocation"
                  },
                  "url": "https://api.cmh.platform-test2.evinternal.net/factory-automeasure/measurement-automation/v2/measurement-automation",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "FacetKeyPointDetection",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "taskToken.$": "$$.Task.Token",
                  "callType": "Service",
                  "auth": {}
                },
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "3DModellingService"
            },
            "3DModellingService": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.3DModellingService",
              "OutputPath": "$",
              "Parameters": {
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
                "Payload": {
                  "requestData": {
                    "orderId.$": "$$.Execution.Input.orderId",
                    "address.$": "$$.Execution.Input.address",
                    "getImageMetadata.$": "$.GetImageMetaData.response.GetImageMetaDataLocation",
                    "imageSelectionService.$": "$.ImageSelection.response.imageSelectionLocation",
                    "facetKeyPointDetection.$": "$.FacetKeyPointDetection.response.facetKeyPointLocation"
                  },
                  "url": "https://measurement-service.cmh.imageproc.evinternal.net/v2/runs",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "3DModellingService",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "taskToken.$": "$$.Task.Token",
                  "callType": "Service",
                  "auth": {}
                }
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "End": true
            }
          }
        }
      ],
      "ResultSelector": {
        "response.$": "$[0]"
      },
      "OutputPath": "$.response",
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "Next": "updateMLAutomationRejected"
        }
      ]
    },
    "ThrottleService": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.ThrottleService",
      "OutputPath": "$",
      "Parameters": {
        "Payload": {
          "orderId.$": "$$.Execution.Input.orderId",
          "reportId.$": "$$.Execution.Input.reportId",
          "workflowId.$": "$$.Execution.Name"
        },
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:test1234:$LATEST"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "Hipster/Twister"
    },
    "Hipster/Twister": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.ThrottleService.response.Path",
          "StringEquals": "twister",
          "Comment": "twister flow",
          "Next": "EVMLJsonConverter_UploadToEvoss"
        }
      ],
      "Default": "UpdateLegacyMLSymphonyAutomationComplete"
    },
    "UpdateLegacyMLSymphonyAutomationComplete": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.UpdateLegacyMLAutomationComplete",
      "OutputPath": "$",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
        "Payload": {
          "orderId.$": "$$.Execution.Input.orderId",
          "reportId.$": "$$.Execution.Input.reportId",
          "workflowId.$": "$$.Execution.Name",
          "taskName": "UpdateLegacyMLSymphonyAutomationComplete",
          "callType": "eagleflow",
          "status": "MASymphonyCompleted",
          "requestData": {}
        }
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "Hipster"
    },
    "Hipster": {
      "Type": "Parallel",
      "Next": "EVMLJsonConverter_UploadToEvoss",
      "Branches": [
        {
          "StartAt": "CreateHipsterJobAndWaitForMeasurement",
          "States": {
            "CreateHipsterJobAndWaitForMeasurement": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.CreateHipsterJobAndWaitForMeasurement",
              "OutputPath": "$",
              "Parameters": {
                "Payload": {
                  "requestData": {
                    "orderId.$": "$$.Execution.Input.orderId",
                    "address.$": "$$.Execution.Input.address",
                    "customerNotes.$": "$$.Execution.Input.customerNotes",
                    "measurementInstructions.$": "$$.Execution.Input.measurementInstructions",
                    "orderType.$": "$$.Execution.Input.orderType",
                    "propertyModelLocation.$": "$.3DModellingService.response.propertyModelLocation"
                  },
                  "url": "http://4b39-2405-201-c013-cd02-148d-d693-3453-fe2d.ngrok.io/hipster",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "CreateHipsterJobAndWaitForMeasurement",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "callType": "hipster",
                  "taskToken.$": "$$.Task.Token",
                  "status": "MeasurementStarted",
                  "auth": {}
                },
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "UpdateHipsterMeasurementCompleteInLegacy"
            },
            "UpdateHipsterMeasurementCompleteInLegacy": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke",
              "ResultSelector": {
                "response.$": "$.Payload"
              },
              "ResultPath": "$.UpdateHipsterMeasurementCompleteInLegacy",
              "OutputPath": "$",
              "Parameters": {
                "Payload": {
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "taskName": "UpdateHipsterMeasurementCompleteInLegacy",
                  "callType": "eagleflow",
                  "status": "MeasurementCompleted",
                  "requestData": {}
                },
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "UpdateHipsterJobAndWaitForQC"
            },
            "UpdateHipsterJobAndWaitForQC": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.UpdateHipsterJobAndWaitForQC",
              "OutputPath": "$",
              "Parameters": {
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
                "Payload": {
                  "requestData": {
                    "mode": "QC"
                  },
                  "url": "http://4b39-2405-201-c013-cd02-148d-d693-3453-fe2d.ngrok.io/qc",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "UpdateHipsterJobAndWaitForQC",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "callType": "hipster",
                  "taskToken.$": "$$.Task.Token",
                  "status": "QCStarted",
                  "hipsterJobId.$": "$.CreateHipsterJobAndWaitForMeasurement.response.jobId",
                  "auth": {}
                }
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "Rework"
            },
            "Rework": {
              "Type": "Choice",
              "Choices": [
                {
                  "Variable": "$.UpdateHipsterJobAndWaitForQC.response.isReworkRequired",
                  "BooleanEquals": true,
                  "Comment": "Rework",
                  "Next": "UpdateHipsterJobAndWaitForMeasurement"
                }
              ],
              "Default": "Pass"
            },
            "Pass": {
              "Type": "Pass",
              "End": true
            },
            "UpdateHipsterJobAndWaitForMeasurement": {
              "Type": "Task",
              "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
              "ResultSelector": {
                "response.$": "$"
              },
              "ResultPath": "$.UpdateHipsterJobAndWaitForMeasurement",
              "OutputPath": "$",
              "Parameters": {
                "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
                "Payload": {
                  "requestData": {
                    "mode": "Measurement"
                  },
                  "url": "http://4b39-2405-201-c013-cd02-148d-d693-3453-fe2d.ngrok.io/hipster",
                  "requestMethod": "POST",
                  "headers": {},
                  "isWaitTask": true,
                  "retry": "number of times we want to retry on specific error types like timeout, 500",
                  "timeout": 15,
                  "storeDataToS3": "",
                  "taskName": "UpdateHipsterJobAndWaitForMeasurement",
                  "orderId.$": "$$.Execution.Input.orderId",
                  "reportId.$": "$$.Execution.Input.reportId",
                  "workflowId.$": "$$.Execution.Name",
                  "callType": "hipster",
                  "taskToken.$": "$$.Task.Token",
                  "status": "MeasurementStarted",
                  "hipsterJobId.$": "$.CreateHipsterJobAndWaitForMeasurement.response.jobId",
                  "auth": {}
                }
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "Lambda.ServiceException",
                    "Lambda.AWSLambdaException",
                    "Lambda.SdkClientException"
                  ],
                  "IntervalSeconds": 2,
                  "MaxAttempts": 6,
                  "BackoffRate": 2
                }
              ],
              "Next": "UpdateHipsterMeasurementCompleteInLegacy"
            }
          }
        }
      ],
      "ResultSelector": {
        "response.$": "$[0]"
      },
      "OutputPath": "$.response",
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "Next": "EVMLJsonConverter_UploadToEvoss"
        }
      ]
    },
    "updateMLAutomationRejected": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.updateMLAutomationRejected",
      "OutputPath": "$",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST",
        "Payload": {
          "orderId.$": "$$.Execution.Input.orderId",
          "reportId.$": "$$.Execution.Input.reportId",
          "workflowId.$": "$$.Execution.Name",
          "taskName": "updateMLAutomationRejected",
          "callType": "eagleflow",
          "status": "MAFailed",
          "requestData": {}
        }
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "updateWorkflowDataToDocDB"
    },
    "EVMLJsonConverter_UploadToEvoss": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.EVMLJsonConverter_UploadToEvoss",
      "OutputPath": "$",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-evmlconverter:$LATEST",
        "Payload": {
          "workflowId.$": "$$.Execution.Name",
          "reportId.$": "$$.Execution.Input.reportId",
          "getImageMetaDataLocation.$": "$.GetImageMetaData.response.GetImageMetaDataLocation"
        }
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "UpdateLegacyStatus"
    },
    "UpdateLegacyStatus": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.UpdateLegacyStatus",
      "OutputPath": "$",
      "Parameters": {
        "Payload": {
          "orderId.$": "$$.Execution.Input.orderId",
          "reportId.$": "$$.Execution.Input.reportId",
          "workflowId.$": "$$.Execution.Name",
          "taskName": "UpdateLegacyStatus",
          "callType": "eagleflow",
          "status.$": "$.EVMLJsonConverter_UploadToEvoss.response.legacyStatus",
          "requestData": {}
        },
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-calloutlambda:$LATEST"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Next": "updateWorkflowDataToDocDB"
    },
    "updateWorkflowDataToDocDB": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "ResultSelector": {
        "response.$": "$.Payload"
      },
      "ResultPath": "$.updateWorkflowDataToDocDB",
      "OutputPath": "$",
      "Parameters": {
        "Payload": {
          "input.$": "$$.Execution.Input",
          "orderId.$": "$$.Execution.Input.orderId",
          "workflowId.$": "$$.Execution.Name",
          "action": "update"
        },
        "FunctionName": "arn:aws:lambda:us-east-2:356071200662:function:app-dev-1x0-lambda-datastorelambda"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "End": true
    }
  }
}